name: Deploy to VPS

on:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: deploy-main
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-24.04
    env:
      TZ: Europe/Rome
      VPS_HOST: ${{ secrets.VPS_HOST }}
      VPS_USER: ${{ secrets.VPS_USER }}
      VPS_APP_DIR: ${{ secrets.VPS_APP_DIR }}
      VPS_SSH_KEY: ${{ secrets.VPS_SSH_KEY }}
      APP_ENV_FILE: ${{ secrets.APP_ENV_FILE }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Verifica delle chiavi
      - name: Preflight .env keys presence
        run: |
          set -euo pipefail
          # Ensure the multi-line secret is available in the environment
          if [ -z "${APP_ENV_FILE:-}" ]; then
            echo "APP_ENV_FILE secret is empty or not provided" >&2
            exit 1
          fi
          required=(
            DATABASE_URL JWT_SECRET BASE_URL
            SIRPLAY_BASE_URL SIRPLAY_API_KEY SIRPLAY_HMAC_SECRET SIRPLAY_WEBHOOK_SECRET
            SIRPLAY_CUSTOMER_ID SIRPLAY_PARTNER_ID
            B2B_BASIC_AUTH_USER B2B_BASIC_AUTH_PASS
          )
          missing=0
          for k in "${required[@]}"; do
            # Use the runtime environment variable and tolerate optional whitespace around '='
            if printf "%s\n" "$APP_ENV_FILE" | grep -Eq "^[[:space:]]*$k[[:space:]]*="; then
              echo "OK $k"
            else
              echo "MISSING $k" >&2
              missing=1
            fi
          done
          test $missing -eq 0

      - name: Rsync repository to VPS
        uses: burnett01/rsync-deployments@5.2
        with:
          switches: -avz --delete --exclude '.git' --exclude 'node_modules'
          path: .
          remote_path: ${{ env.VPS_APP_DIR }}/
          remote_host: ${{ env.VPS_HOST }}
          remote_user: ${{ env.VPS_USER }}
          remote_key: ${{ env.VPS_SSH_KEY }}

      - name: Write .env on VPS (from APP_ENV_FILE secret)
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ env.VPS_HOST }}
          username: ${{ env.VPS_USER }}
          key: ${{ env.VPS_SSH_KEY }}
          script: |
            set -e
            mkdir -p "${{ env.VPS_APP_DIR }}"
            cat > "${{ env.VPS_APP_DIR }}/.env" <<'EOF__APP_ENV'
            ${{ env.APP_ENV_FILE }}
            EOF__APP_ENV
            chmod 600 "${{ env.VPS_APP_DIR }}/.env"

      - name: Install deps, build on VPS, prune and reload PM2
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ env.VPS_HOST }}
          username: ${{ env.VPS_USER }}
          key: ${{ env.VPS_SSH_KEY }}
          script: |
            set -e
            cd "${{ env.VPS_APP_DIR }}"

            # Node 20 via nvm (se presente)
            if [ -s "$HOME/.nvm/nvm.sh" ]; then . "$HOME/.nvm/nvm.sh"; fi
            if command -v nvm >/dev/null 2>&1; then nvm install 20 >/dev/null; nvm use 20; fi
            node -v

            # Non eseguire il sourcing della .env nello shell: valori con spazi/JSON possono rompere la build.
            # L'app carica la .env da Node (dotenv) all'avvio.

            # deps + build + prune (runtime only)
            npm ci --include=dev --no-audit --no-fund
            npm run build
            npm prune --omit=dev --no-audit --no-fund

            # PM2
            command -v pm2 >/dev/null 2>&1 || npm i -g pm2
            if [ -f pm2.config.cjs ]; then
              pm2 reload pm2.config.cjs --update-env || pm2 start pm2.config.cjs
            elif [ -f ecosystem.config.cjs ]; then
              pm2 reload ecosystem.config.cjs --update-env || pm2 start ecosystem.config.cjs
            else
              pm2 restart all || true
            fi
            pm2 save || true

      - name: Smoke check /api/healthz (with retries)
        run: |
          set -e
          url="https://dev.kasyrooms.com/api/healthz"
          attempts=10
          delay=3
          for i in $(seq 1 $attempts); do
            if curl -fsS -L "$url" >/dev/null; then
              echo "Health check OK on attempt $i"
              exit 0
            fi
            echo "Health check failed (attempt $i/$attempts). Waiting ${delay}s..."
            sleep $delay
          done
          echo "Health check failed after $attempts attempts"
          curl -v "$url" || true
          exit 1
